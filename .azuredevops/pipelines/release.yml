trigger:
- none

resources:
  pipelines:
  - pipeline: Build
    source: Build\baptistecabrera.com
    trigger: 
      branches:
      - main

variables:
- group: CloudFlare
- name: artifactPath
  value: $(Pipeline.Workspace)/Build/$(resources.pipeline.Build.runName)

stages:
- stage: Initialization
  displayName: Initialization
  jobs:
  - job: Initialize
    displayName: Initialize Release
    steps:
    - checkout: none
    - powershell: Write-Host "##vso[build.updatebuildnumber]$(Build.DefinitionName)-$(Build.BuildNumber)"
      displayName: Set Build Number
- stage: Release
  displayName: Release
  pool:
    name: Azure Pipelines
    vmImage: ubuntu-latest
  jobs:
  - job: Release
    displayName: Release Website
    steps:
    - checkout: none
    - task: DownloadPipelineArtifact@2
      displayName: 'Download Pipeline Artifact'
      inputs:
        source: specific
        project: '$(resources.pipeline.Build.projectID)'
        pipeline: '$(resources.pipeline.Build.pipelineID)'
        preferTriggeringPipeline: true
        runVersion: specific
        runId: '$(resources.pipeline.Build.runID)'
        artifact: '$(resources.pipeline.Build.runName)'
        path: '$(artifactPath)'
    - powershell: Get-ChildItem $(artifactPath) -Recurse
      displayName: List Build Artifacts
    - script: |
        npm install $(artifactPath) @cloudflare/wrangler
        cd $(artifactPath)
        ls
        CF_ACCOUNT_ID=$CF_ACCOUNT_ID CF_API_TOKEN=CF_API_TOKEN wrangler publish
      displayName: Install Wrangler and Publish
      env:
        CF_ACCOUNT_ID: $(CloudFlareAccountId)
        CF_API_TOKEN: $(CloudFlareApiToken)
